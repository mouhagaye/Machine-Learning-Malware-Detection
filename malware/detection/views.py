from django.shortcuts import render
from .malware import *
import shutil
import json
from django.http import JsonResponse

from django.http import HttpResponse
from django.template import loader


# Create your views here.

def index(request):
    return render(request,'detection.html')

def analyse(request):
    path = request.POST.get("path")
    print("===============Le chemin est ",path)
    print("=====================",os.getcwd())

    clf = joblib.load('detection/classifier/classifier.pkl')
    features = pickle.loads(open(os.path.join('detection/classifier/features.pkl'),'rb').read())
    try:
        data = extract_infos(path)
        pe_features = list(map(lambda x:data[x], features))
        res= clf.predict([pe_features])[0]
        res =  ['malware', 'fichier sain'][res]
        #print('Le fichier %s est un %s' % (path,['malware', 'fichier sain'][res]))
        print("=============="+res+"=====================")
        #os.unlink(path)
    except:
        return JsonResponse({"success":False})
    return JsonResponse({"success":True,"verdict":res})

def supprimer(request):
    path = request.POST.get("path")
    try:
        os.remove(path)
        print("=================Suppression reussi==================")

    except:
        return JsonResponse({"success":False}) 

    return JsonResponse({"success":True})

def quarantaine(request):
    path = request.POST.get("path")
    try:
        shutil.move(path, "C:/Users/Mouhamadou Gaye/Documents/Projet Python/StageSonatel/siteweb/Quarantaine")
        print("=================Quarantaine Reussit ==================")

    except:
        return JsonResponse({"success":False})
    return JsonResponse({"success":True})    
def login(request):
    return render(request, 'login.html')